
var fs = require("fs");

//the method may throw exception, we need catch when invoke.
var config = module.exports;


//sync
config.readsync = function(file){
  
   var str = fs.readFileSync(file,"utf8");
   
   return parse_conf(str);
};

//async
config.read = function(file,cb){
   
   fs.readFile(file,"utf8",function(err,str){
      var conf;
      if(!err)
      {
	 try{
	    conf = parse_conf(str);
	 }catch(e){
	    err = e;
	 }
      }
      
      if(typeof cb == "function"){
	 cb(err,conf);
      }
   });
};


//helper function
function parse_conf(str){
   
   //remove all comment
   var reg = /"(\\[\s\S]|[^"])*"|'(\\[\s\S]|[^'])*'|((#|\/\/).*|\/\*[\s\S]*?\*\/)/g;
   
   var newstr = str.replace(reg, function(all, strDouble, strSingle, comment) {
      if (comment) {
         return "";
      }
      return all;
   });
   
   //remove all blank but not in ""
   newstr = newstr.replace(/\s*([^\s"]*)\s*("[^"]*")?/g,"$1$2");
   
   //modify str for json format
   newstr = newstr.replace(/((\{|,)(\w+)(:))/g,"$2\"$3\"$4");
   
   var conf = JSON.parse(newstr);
   
   return conf;   
}



